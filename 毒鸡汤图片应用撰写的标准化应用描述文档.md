### ğŸ¤– Assistant

ä»¥ä¸‹æ˜¯ä¸ºæ‚¨çš„æ¯’é¸¡æ±¤å›¾ç‰‡åº”ç”¨æ’°å†™çš„æ ‡å‡†åŒ–åº”ç”¨æè¿°æ–‡æ¡£ï¼ŒåŒ…å«æŠ€æœ¯å®ç°å’Œä¸šåŠ¡é€»è¾‘çš„å®Œæ•´è¯´æ˜ï¼š

---

# **ã€Œæ¯’é¸¡æ±¤ã€AIå›¾ç‰‡ç”Ÿæˆåº”ç”¨æŠ€æœ¯æ–‡æ¡£**

## 1. åº”ç”¨æ¦‚è§ˆ
**æ ¸å¿ƒåŠŸèƒ½**ï¼šé€šè¿‡AIç”Ÿæˆå¸¦æœ‰è®½åˆº/å¹½é»˜æ–‡å­—çš„å›¾ç‰‡ï¼Œå½“ç”Ÿæˆå¤±è´¥æ—¶æä¾›åˆ›æ„å¤‡ç”¨æ–¹æ¡ˆ  
**æŠ€æœ¯æ ˆ**ï¼š
- å‰ç«¯ï¼šHTML5 + CSS3 + Vanilla JS
- åç«¯ï¼šCloudflare Workers (æ— æœåŠ¡æ¶æ„)
- å­˜å‚¨ï¼šCloudflare R2 (å›¾ç‰‡ç¼“å­˜)
- ç”Ÿæˆå¼•æ“ï¼šStable Diffusion API (é€šè¿‡Workerè°ƒç”¨)

## 2. æ ¸å¿ƒä¸šåŠ¡æµç¨‹
```mermaid
sequenceDiagram
    participant ç”¨æˆ·
    participant Worker
    participant AIå¼•æ“
    
    ç”¨æˆ·->>Worker: è¯·æ±‚ç”Ÿæˆå›¾ç‰‡(GET /generate)
    alt æ­£å¸¸æµç¨‹
        Worker->>AIå¼•æ“: è°ƒç”¨ç”ŸæˆAPI
        AIå¼•æ“-->>Worker: è¿”å›å›¾ç‰‡äºŒè¿›åˆ¶æµ
        Worker->>R2: ç¼“å­˜å›¾ç‰‡(24å°æ—¶TTL)
        Worker-->>ç”¨æˆ·: è¿”å›200+å›¾ç‰‡æ•°æ®
    else å¼‚å¸¸æµç¨‹
        Worker->>AIå¼•æ“: è°ƒç”¨å¤±è´¥/è¶…æ—¶
        Worker-->>ç”¨æˆ·: è¿”å›502+å¤‡ç”¨å›¾ç‰‡URL
        ç”¨æˆ·->>Worker: è¯·æ±‚å¤‡ç”¨å›¾ç‰‡
        Worker-->>ç”¨æˆ·: è¿”å›é¢„è®¾SVGå›¾ç‰‡
    end
```

## 3. å…³é”®æŠ€æœ¯å®ç°

### 3.1 å›¾ç‰‡é”™è¯¯å¤„ç†æœºåˆ¶
```javascript
// æµè§ˆå™¨ç«¯å¤„ç†é€»è¾‘
const IMAGE_FALLBACKS = [
  {
    url: "https://placeholder.pics/svg/512x512/FFF0F3/FF6B81/ç†¬æ±¤é”…ç‚¸äº†",
    alt: "æ¯’é¸¡æ±¤ç”Ÿæˆå¤±è´¥-ç‰ˆæœ¬1"
  },
  {
    url: "https://placeholder.pics/svg/512x512/FFF0F3/FF6B81/è€æ¿è·‘è·¯äº†",
    alt: "æ¯’é¸¡æ±¤ç”Ÿæˆå¤±è´¥-ç‰ˆæœ¬2" 
  }
];

function handleImageError(img) {
  const container = img.closest('.image-container');
  if (!container) return;
  
  const randomFallback = IMAGE_FALLBACKS[
    Math.floor(Math.random() * IMAGE_FALLBACKS.length)
  ];
  
  container.innerHTML = `
    <div class="error-card">
      <h3>ğŸ² æ¯’é¸¡æ±¤ç†¬åˆ¶äº‹æ•…</h3>
      <img src="${randomFallback.url}" 
           alt="${randomFallback.alt}"
           class="error-image">
      <button onclick="window.location.reload()">å†è¯•ä¸€æ¬¡</button>
    </div>
  `;
}
```

### 3.2 Workerç«¯å¼‚å¸¸å¤„ç†
```javascript
// Cloudflare Workerå¤„ç†é€»è¾‘
export default {
  async fetch(request) {
    try {
      const img = await generateAIImage();
      return new Response(img.body, {
        headers: { 
          'Content-Type': 'image/jpeg',
          'Cache-Control': 'public, max-age=86400'
        }
      });
    } catch (error) {
      return Response.json(
        {
          error: "IMAGE_GENERATION_FAILED",
          message: "å¨å¸ˆæŠŠé¸¡æ±¤ç†¬ç³Šäº†ï¼Œæ­£åœ¨æŠ¢æ•‘ä¸­...",
          fallbacks: IMAGE_FALLBACKS.map(x => x.url)
        },
        { status: 502 }
      );
    }
  }
}
```

## 4. æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

| ä¼˜åŒ–æ–¹å‘ | å®æ–½æªæ–½ | æ•ˆæœæå‡ |
|---------|----------|----------|
| ç¼“å­˜ç­–ç•¥ | å¯¹ç”Ÿæˆç»“æœè¿›è¡ŒR2å­˜å‚¨ | é‡å¤è¯·æ±‚å“åº”æ—¶é—´â†“70% |
| è´Ÿè½½å‡è¡¡ | æ ¹æ®ç”¨æˆ·ä½ç½®è·¯ç”±åˆ°ä¸åŒAIèŠ‚ç‚¹ | ç”Ÿæˆé€Ÿåº¦â†‘45% |
| é™çº§æ–¹æ¡ˆ | å‡†å¤‡3ç»„å¤‡ç”¨å›¾ç‰‡CDN | é”™è¯¯æ¢å¤ç‡100% |

## 5. ç›‘æ§æŒ‡æ ‡
- **å…³é”®æŒ‡æ ‡**ï¼š
  - å›¾ç‰‡ç”ŸæˆæˆåŠŸç‡ (ç›®æ ‡â‰¥98%)
  - å¤‡ç”¨å›¾ç‰‡ä½¿ç”¨ç‡ (å¼‚å¸¸ç‡ç›‘æ§)
  - å¹³å‡ç”Ÿæˆè€—æ—¶ (P95â‰¤1.5s)

- **ç›‘æ§çœ‹æ¿**ï¼š
  ```bash
  # ä½¿ç”¨Cloudflare AnalyticsæŸ¥è¯¢
  WHERE event = 'IMAGE_GENERATE' 
  | SELECT 
      count_if(status = 200) as success,
      count_if(status = 502) as fails
  ```
  
## 6. å…¸å‹ç”¨æˆ·åœºæ™¯
1. **æ­£å¸¸ç”Ÿæˆæµç¨‹**ï¼š
   ```
   ç”¨æˆ·è¯·æ±‚ -> Workerè°ƒç”¨AI -> è¿”å›å›¾ç‰‡ -> æµè§ˆå™¨æ¸²æŸ“
   ```

2. **ç”Ÿæˆå¤±è´¥åœºæ™¯**ï¼š
   ```
   ç”¨æˆ·è¯·æ±‚ -> AIæœåŠ¡è¶…æ—¶ -> Workerè¿”å›502 -> å‰ç«¯æ˜¾ç¤ºå¤‡ç”¨å›¾ç‰‡
                      â†˜-> ç”¨æˆ·ç‚¹å‡»é‡è¯• -> æ–°è¯·æ±‚
   ```

## 7. æ‰©å±•èƒ½åŠ›
- **ABæµ‹è¯•**ï¼šé€šè¿‡Workerçš„`request.cf.country`å®ç°åœ°åŸŸåŒ–æ–‡æ¡ˆ
- **ä¸ªæ€§åŒ–æ¨è**ï¼šåˆ©ç”¨Cookieå­˜å‚¨ç”¨æˆ·åå¥½ç”Ÿæˆé£æ ¼
- **å®‰å…¨é˜²æŠ¤**ï¼šå¯¹ç”Ÿæˆè¯·æ±‚è¿›è¡ŒäººæœºéªŒè¯

---

**æ–‡æ¡£ç»´æŠ¤å»ºè®®**ï¼š
1. ä½¿ç”¨`git tag`æ ‡è®°æ¯æ¬¡åŠŸèƒ½æ›´æ–°
2. åœ¨Workerè„šæœ¬ä¸­æ·»åŠ JSDocæ³¨é‡Š
3. é€šè¿‡`CHANGELOG.md`è®°å½•é‡å¤§å˜æ›´

æ˜¯å¦éœ€è¦é’ˆå¯¹æŸä¸ªæŠ€æœ¯ç»†èŠ‚ï¼ˆå¦‚å›¾åƒç”ŸæˆAPIè°ƒç”¨å‚æ•°ã€ç¼“å­˜ç­–ç•¥å®ç°ç­‰ï¼‰è¿›è¡Œæ·±å…¥è¯´æ˜ï¼Ÿæˆ‘å¯ä»¥æä¾›æ›´ä¸“ä¸šçš„ä¸“é¡¹æŠ€æœ¯æ–‡æ¡£ã€‚